<!DOCTYPE html>
<html lang="en">
<!-- Head and other styles remain the same until the icon styles -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .contacts-container {
            display: flex;
            height: 100vh;
            background-color: #f8f9fa;
        }

        .contacts-sidebar {
            width: 300px;
            border-right: 1px solid #dee2e6;
            background-color: white;
            padding: 1rem;
        }

        .contacts-main {
            flex-grow: 1;
            padding: 2rem;
            background-color: white;
            display: flex;
            flex-direction: column;
        }

        .contact-list-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .contact-list-item:hover {
            background-color: #f8f9fa;
        }

        .contact-list-item.selected {
            background-color: #0d6efd;
            color: white;
        }

        .email-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: fit-content;
            min-height: 38px;
            /* Match Bootstrap input height */
        }

        .email-input {
            flex-grow: 1;
        }

        .delete-email {
            visibility: hidden;
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
            color: #dc3545;
        }

        .email-item:hover .delete-email {
            visibility: visible;
        }

        .email-text {
            flex-grow: 0;
            padding: 0.375rem 0;
            /* Match Bootstrap input padding */
        }

        .new-email-form {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            width: 50%;
        }

        .new-email-form .form-control {
            flex-grow: 1;
        }


        .circle-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
            color: #0d6efd;
        }

        .circle-btn svg {
            width: 100%;
            height: 100%;
        }

        .circle-btn.small {
            width: 24px;
            height: 24px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .add-email-btn {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: #0d6efd;
            padding: 0;
            cursor: pointer;
            gap: 0.5rem;
        }

        .add-email-btn:hover {
            color: #0b5ed7;
        }

        .contact-form {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-content {
            flex: 1;
        }

        .form-buttons {
            padding-top: 2rem;
            border-top: 1px solid #dee2e6;
            margin-top: auto;
        }
    </style>
</head>

<body>
    <div class="contacts-container">
        <div class="contacts-sidebar">
            <div class="sidebar-header">
                <h1 class="h4 mb-0">Contacts</h1>
                <button class="circle-btn" id="addContactBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div id="contactsList"></div>
        </div>
        <div class="contacts-main">
            <form id="contactForm" class="contact-form needs-validation" novalidate>
                <div class="form-content">
                    <div class="row mb-4">
                        <div class="col">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" required>
                            <div class="invalid-feedback">
                                First name is required
                            </div>
                        </div>
                        <div class="col">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" required>
                            <div class="invalid-feedback">
                                Last name is required
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Email</label>
                        <div id="emailList"></div>
                        <button type="button" class="add-email-btn" id="addEmailBtn">
                            <div class="circle-btn small">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                            <span>Add email</span>
                        </button>
                    </div>
                </div>

                <div class="form-buttons d-flex justify-content-between">
                    <button type="button" class="btn btn-danger" id="deleteContactBtn">Delete</button>
                    <div>
                        <button type="button" class="btn btn-light me-2" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        class ContactsApp {
            constructor() {
                this.currentContact = null;
                this.baseUrl = window.location.origin;
                this.setupEventListeners();
                this.loadContacts();
            }

            setupEventListeners() {
                document.getElementById('contactForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveContact();
                });

                document.getElementById('addContactBtn').addEventListener('click', () => {
                    this.clearForm();
                    this.currentContact = null;
                });

                document.getElementById('addEmailBtn').addEventListener('click', () => {
                    this.addEmailField();
                });

                document.getElementById('deleteContactBtn').addEventListener('click', () => {
                    if (this.currentContact) {
                        this.deleteContact(this.currentContact.id);
                    }
                });

                document.getElementById('cancelBtn').addEventListener('click', () => {
                    this.clearForm();
                    this.currentContact = null;
                });
            }

            async loadContacts() {
                try {
                    console.log('Loading contacts...');
                    const response = await fetch(`${this.baseUrl}/api/contacts`);
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const contacts = await response.json();
                    console.log('Loaded contacts:', contacts);
                    this.displayContacts(contacts);
                } catch (error) {
                    console.error('Error loading contacts:', error);
                }
            }

            displayContacts(contacts) {
                const contactsList = document.getElementById('contactsList');
                contactsList.innerHTML = '';

                if (contacts.length === 0) {
                    const div = document.createElement('div');
                    div.className = 'p-3 text-muted';
                    div.textContent = 'No contacts yet';
                    contactsList.appendChild(div);
                    return;
                }

                contacts.forEach(contact => {
                    const div = document.createElement('div');
                    div.className = 'contact-list-item';
                    if (this.currentContact && this.currentContact.id === contact.id) {
                        div.classList.add('selected');
                    }
                    div.textContent = `${contact.firstName} ${contact.lastName}`;
                    div.addEventListener('click', () => this.loadContact(contact.id));
                    contactsList.appendChild(div);
                });
            }

            async loadContact(id) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/contacts/${id}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const contact = await response.json();
                    this.displayContact(contact);
                    this.currentContact = contact;
                    this.loadContacts();
                } catch (error) {
                    console.error('Error loading contact:', error);
                }
            }

            displayContact(contact) {
                document.getElementById('firstName').value = contact.firstName;
                document.getElementById('lastName').value = contact.lastName;

                const emailList = document.getElementById('emailList');
                emailList.innerHTML = '';

                contact.emails.forEach(emailObj => {
                    this.addEmailDisplay(emailObj.email);
                });
            }

            addEmailField() {
                const emailList = document.getElementById('emailList');

                // Create form for new email
                const newEmailForm = document.createElement('div');
                newEmailForm.className = 'new-email-form';

                const input = document.createElement('input');
                input.type = 'email';
                input.className = 'form-control';
                input.placeholder = 'Enter email address';
                input.required = true;

                const saveBtn = document.createElement('button');
                saveBtn.type = 'button';
                saveBtn.className = 'btn btn-primary btn-sm';
                saveBtn.textContent = 'Add';

                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn btn-light btn-sm';
                cancelBtn.textContent = 'Cancel';

                // Handle save
                saveBtn.onclick = () => {
                    if (input.checkValidity()) {
                        this.addEmailDisplay(input.value);
                        newEmailForm.remove();
                    } else {
                        input.reportValidity();
                    }
                };

                // Handle cancel
                cancelBtn.onclick = () => {
                    newEmailForm.remove();
                };

                newEmailForm.appendChild(input);
                newEmailForm.appendChild(saveBtn);
                newEmailForm.appendChild(cancelBtn);
                emailList.appendChild(newEmailForm);

                input.focus();
            }

            addEmailDisplay(emailValue) {
                const emailList = document.getElementById('emailList');
                const emailItem = document.createElement('div');
                emailItem.className = 'email-item mb-2';

                const emailText = document.createElement('span');
                emailText.className = 'email-text';
                emailText.textContent = emailValue;

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'delete-email';
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm3 10.5a.75.75 0 0 0 0-1.5H9a.75.75 0 0 0 0 1.5h6Z" clip-rule="evenodd" />
                    </svg>
                `;
                deleteBtn.onclick = () => emailItem.remove();

                emailItem.appendChild(emailText);
                emailItem.appendChild(deleteBtn);
                emailList.appendChild(emailItem);
            }

            clearForm() {
                document.getElementById('contactForm').reset();
                document.getElementById('emailList').innerHTML = '';
            }

            async saveContact() {
                const form = document.getElementById('contactForm');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const emailSpans = document.querySelectorAll('#emailList .email-text');
                const emails = Array.from(emailSpans).map(span => ({
                    email: span.textContent
                }));

                const contactData = {
                    firstName,
                    lastName,
                    emails
                };

                try {
                    const url = this.currentContact
                        ? `${this.baseUrl}/api/contacts/${this.currentContact.id}`
                        : `${this.baseUrl}/api/contacts`;
                    const method = this.currentContact ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(contactData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Error saving contact');
                    }

                    this.clearForm();
                    this.currentContact = null;
                    this.loadContacts();
                } catch (error) {
                    console.error('Error saving contact:', error);
                    alert(error.message);
                }
            }

            async deleteContact(id) {
                if (!confirm('Are you sure you want to delete this contact?')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.baseUrl}/api/contacts/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Error deleting contact');
                    }

                    this.clearForm();
                    this.currentContact = null;
                    this.loadContacts();
                } catch (error) {
                    console.error('Error deleting contact:', error);
                    alert(error.message);
                }
            }
        }

        // Initialize the app when the document is ready
        document.addEventListener('DOMContentLoaded', () => {
            new ContactsApp();
        });
    </script>
</body>

</html>